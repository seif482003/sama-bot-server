```html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>سما — المساعد الذكي</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1:#020617;
    --bg-2:#05102a;
    --neon-cyan:#00f0ff;
    --neon-mag:#b600ff;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:"Tajawal",system-ui,Segoe UI,Helvetica,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#eafcff}
  /* animated city background */
  .bg {
    position:fixed; inset:0; z-index:0; overflow:hidden;
    background:
      radial-gradient(500px 240px at 12% 8%, rgba(182,0,255,0.06), transparent 8%),
      radial-gradient(700px 320px at 88% 20%, rgba(0,240,255,0.04), transparent 8%),
      linear-gradient(180deg, rgba(5,10,25,0.6), rgba(2,6,15,0.9));
  }
  /* floating skyline lines */
  .layer {
    position:absolute; left:0; right:0; bottom:-10%;
    height:50%;
    background-repeat:repeat-x;
    opacity:0.16;
    filter:blur(8px) saturate(1.1);
    animation: floatX 30s linear infinite;
    background-size:contain;
  }
  .layer.l1{ background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="260"><g fill="%23b600ff" fill-opacity="0.25"><rect x="40" y="90" rx="6" width="80" height="120"/><rect x="140" y="40" rx="6" width="60" height="170"/><rect x="220" y="120" rx="6" width="120" height="90"/><rect x="360" y="20" rx="6" width="140" height="190"/><rect x="530" y="70" rx="6" width="90" height="140"/><rect x="640" y="30" rx="6" width="110" height="180"/><rect x="780" y="90" rx="6" width="80" height="120"/></g></svg>'); bottom:0; transform:translateY(8%); animation-duration:38s;}
  .layer.l2{ background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="200"><g fill="%2300f0ff" fill-opacity="0.18"><rect x="120" y="70" rx="6" width="100" height="130"/><rect x="320" y="20" rx="6" width="140" height="170"/><rect x="520" y="100" rx="6" width="90" height="100"/><rect x="760" y="10" rx="6" width="160" height="190"/><rect x="1060" y="60" rx="6" width="80" height="140"/></g></svg>'); bottom:-6%; transform:translateY(12%); animation-duration:48s; opacity:0.12;}
  @keyframes floatX { from { background-position-x: 0; } to { background-position-x: -1600px; } }

  /* main container */
  .wrap{position:relative; z-index:2; max-width:1100px; margin:28px auto; height:88vh; display:grid; grid-template-rows: auto 1fr auto; gap:12px; padding:16px;}
  header.app-header{display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .avatar{width:64px;height:64px;border-radius:12px; background:linear-gradient(135deg,var(--neon-mag),var(--neon-cyan)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px; box-shadow:0 10px 30px rgba(182,0,255,0.12)}
  .title{font-weight:800; font-size:20px}
  .subtitle{font-size:13px;color:rgba(234,252,255,0.75)}

  /* chat box */
  .chat{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:0 12px 40px rgba(2,6,23,0.6);
  }
  .msgs{flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth}
  .bubble{max-width:78%; padding:12px 14px; border-radius:12px; line-height:1.45; position:relative; animation:pop .28s ease}
  @keyframes pop{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
  .bubble.bot{background:linear-gradient(135deg, rgba(182,0,255,0.06), rgba(0,240,255,0.03)); border:1px solid rgba(182,0,255,0.06)}
  .bubble.me{margin-left:auto; background:linear-gradient(135deg, rgba(0,240,255,0.08), rgba(182,0,255,0.04)); border:1px solid rgba(0,240,255,0.06)}
  .meta{font-size:12px;color:rgba(230,247,255,0.6); margin-top:8px}

  /* composer */
  .composer{display:flex; gap:10px; align-items:flex-end; padding:8px}
  textarea.input{flex:1; min-height:48px; max-height:200px; resize:none; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:var(--glass); color:inherit}
  .controls{display:flex; gap:8px; align-items:center}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--neon-cyan); cursor:pointer; font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--neon-mag),var(--neon-cyan)); color:#021; border:0; box-shadow:0 10px 30px rgba(182,0,255,0.12)}
  .attach-thumb{width:64px;height:64px;border-radius:8px; overflow:hidden; background:#071022; display:flex; align-items:center; justify-content:center}

  /* footer small */
  .foot{font-size:12px;color:rgba(234,252,255,0.6); text-align:center}

  @media (max-width:900px){
    .wrap{margin:12px; height:92vh}
    .avatar{width:52px;height:52px}
  }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="layer l1" aria-hidden="true"></div>
  <div class="layer l2" aria-hidden="true"></div>

  <div class="wrap" role="application" aria-label="واجهة سما">
    <header class="app-header">
      <div class="avatar" aria-hidden="true">سما</div>
      <div>
        <div class="title">سما — المساعد الذكي</div>
        <div class="subtitle">تفاصيل متعمقة عن المدن الذكية، التكنولوجيا، والذكاء الاصطناعي</div>
      </div>
    </header>

    <main class="chat" aria-live="polite">
      <div id="msgs" class="msgs" role="log" tabindex="0" aria-live="polite"></div>

      <div class="composer">
        <textarea id="input" class="input" placeholder="اكتب سؤالك هنا... (Enter للإرسال, Shift+Enter لسطر جديد)"></textarea>
        <div class="controls">
          <input id="attachInput" type="file" accept="image/*" style="display:none">
          <button id="attachBtn" class="btn" title="إضافة صورة">🖼️</button>
          <button id="sendBtn" class="btn primary">إرسال</button>
        </div>
      </div>
    </main>

    <div class="foot">نسخة عرض — لا صوت • جاهزة للربط بالسيرفر لاحقًا</div>
  </div>

<script>
/* ---- state ---- */
const STORAGE_KEY = 'sama-ui-v3';
let state = { messages: [], attachments: [] };

/* ---- large knowledge base (مفصلة) ----
   قاعدة بيانات باللغة العربية بمحتوى تفصيلي في المدن الذكية، التكنولوجيا والذكاء الاصطناعي.
   (يمكن توسيعها لاحقاً أو ربطها بقاعدة بيانات خارجية)
*/
const KB = [
  // المدن الذكية — تعريف عام
  { q: ["ما هي المدينة الذكية","تعريف المدينة الذكية","يعني ايه مدينة ذكية"], a:
`المدينة الذكية هي نظام حضري متكامل يعتمد على جمع وتحليل البيانات من خلال أجهزة الاستشعار، شبكات الاتصالات، ومنصات تحليل البيانات لاتخاذ قرارات ذكية. الهدف هو تحسين جودة الحياة للمواطنين بتخفيض الازدحام، تقليل استهلاك الطاقة، تحسين الرعاية الصحية، وتقديم خدمات عامة أكثر كفاءة. التطبيق العملي يشمل إشارات مرور ذكية، شبكات طاقة مرنة (Smart Grids)، إدارة نفايات ذكية، ونظم مراقبة بيئية.` },

  // الطاقة
  { q: ["الطاقة","كيف نوفر الطاقة","شبكات ذكية"], a:
`في المدن الذكية تُستخدم مجموعة من الحلول لرفع كفاءة الطاقة: 
1) شبكات ذكية (Smart Grids) تسمح بتوزيع ذكي للطاقة وموازنة العرض والطلب، وتدعم دمج مصادر متجددة. 
2) الأنظمة الموزعة للطاقة (مثل ألواح شمسية على المباني) مع تخزين طاقة محلي (batteries) لتغطية أوقات الذروة. 
3) إدارة المباني الذكية (BMS) التي تتحكم في الإضاءة والتكييف حسب الاستخدام الفعلي. 
التخطيط يحتاج إلى قياس الاستهلاك، نمذجة الطلب، واستراتيجيات تسعير تحفيزية لتقليل الذروة.` },

  // المواصلات
  { q: ["المواصلات","النقل","الزحام"], a:
`حلول النقل في المدن الذكية مبنية على البيانات: 
- إشارات مرور ديناميكية تعتمد على تدفق المركبات. 
- أنظمة نقل جماعي متصلة توفر معلومات زمنية حقيقية للمسافرين. 
- مشاركة المركبات والدراجات الكهربائية تقلل الحاجة للسيارات الخاصة. 
- المركبات الذاتية والربط بين المركبات والبنية التحتية (V2X) تحسن السلامة وتقلل الحوادث. 
التنفيذ يتطلب بنية اتصالات موثوقة (5G/LoRaWAN) ونماذج تحكم ذكية لإدارة تدفقات المرور.` },

  // الأمن والمراقبة
  { q: ["الأمن","كاميرات","مراقبة"], a:
`الأمن في المدن الذكية يعتمد على تحليل الفيديو والبيانات لاكتشاف الحوادث والأنماط الشاذة. تقنيات مثل رؤية الحاسوب (Computer Vision) والتعرف على السلوك تُستخدم لاستخراج إنذارات فورية. مع ذلك يجب مراعاة قوانين الخصوصية، التشفير، وتحديد سياسات الاحتفاظ بالبيانات والنهج الأخلاقي لاستخدام المراقبة.` },

  // البيئة وجودة الهواء
  { q: ["البيئة","تلوث","جودة الهواء"], a:
`أجهزة استشعار منتشرة تقيس جودة الهواء، الضوضاء، وملوثات المياه. تُستخدم البيانات لتشغيل سياسات سريعة: مثلاً تقييد مركبات الديزل مؤقتًا أو تعديل إشارات المرور لتقليل التكدس في مناطق التلوث. بالإضافة إلى أنظمة إدارة النفايات الذكية التي تحدد مواعيد الجمع بناءً على امتلاء الحاويات لتقليل الموارد والتكاليف.` },

  // الصحة
  { q: ["الصحة","المستشفى","الرعاية عن بعد"], a:
`المدن الذكية تحسن الرعاية الصحية عبر: 
- مراقبة المرضى عن بُعد باستخدام أجهزة متصلة (Remote Monitoring). 
- نظم إنذار مبكر تعتمد على تحليل البيانات للوقاية من تفشيات الأمراض. 
- تخصيص الموارد (مثل الأسرة والأطباء) بناءً على التنبؤ بالطلب. 
أمان البيانات وحماية خصوصية المرضى أمران محوريان عند تطبيق هذه الحلول.` },

  // التعليم
  { q: ["التعليم","التعلم","الفصول الافتراضية"], a:
`التعليم في المدن الذكية يستفيد من منصات تعليمية متصلة، فصول افتراضية، ومحتوى متكيف (Adaptive Learning) يعتمد على أداء الطالب. تقنيات AR/VR تُستخدم للمحاكاة والتدريب العملي، ما يوسع فرص التعلم ويحسن نتائج التعليم المهني.` },

  // إنترنت الأشياء IoT
  { q: ["انترنت الاشياء","iot","اجهزة استشعار"], a:
`إنترنت الأشياء (IoT) هو العمود الفقري للمدن الذكية: آلاف أجهزة الاستشعار تجمع بيانات عن حركة المرور، الطاقة، جودة الهواء، وغيرها. البيانات تُرسل إلى منصات سحابية أو حافة الشبكة (edge) لمعالجتها وتحليلها. اختيار البروتوكولات (مثل MQTT, CoAP) ومعايير الشبكة مهم جداً لتأمين الاتصال وتقليل استهلاك الطاقة.` },

  // شبكات الاتصال
  { q: ["5g","lora","شبكات","اتصالات"], a:
`شبكات الاتصال اللازمة للمدن الذكية تختلف حسب الحاجة: 
- 5G يقدم عرض نطاق عالي وزمن انتقال منخفض للخدمات الحرجة. 
- LoRaWAN وNB-IoT مناسبان للأجهزة منخفضة الطاقة لمسافات طويلة. 
التصميم المتوازن يجمع بين تقنيات عدة لتغطية الحؤول والقياس والتكلفة.` },

  // البيانات والتحليلات
  { q: ["تحليل البيانات","big data","analytics"], a:
`جمع كميات كبيرة من البيانات يتطلب بنية تخزينية وتحليلية قوية: 
- أنظمة تخزين بيانات (Data Lakes) وبيانات مؤسسية. 
- تحليل في الوقت الحقيقي (stream processing) للتعامل مع تدفقات المستشعرات. 
- نماذج تعلم آلي للتنبؤ بالطلب، كشف الأنماط، وتحسين إدارة الموارد. 
كما يجب وجود سياسات جودة بيانات ودمج مصادر متعددة.` },

  // التوأم الرقمي Digital Twin
  { q: ["التوأم الرقمي","digital twin"], a:
`التوأم الرقمي هو نموذج رقمي مفصل لكائن مادي (مبنى، شبكة، أو مدينة كاملة) يتم تحديثه بالبيانات الحية من المستشعرات. يسمح بمحاكاة سيناريوهات مختلفة (مثل تأثير تغيير مسار المرور أو إضافة محطة شحن) قبل التطبيق الحقيقي، ما يقلل المخاطر ويزيد من كفاءة التخطيط.` },

  // الصيانة التنبؤية
  { q: ["الصيانة التنبؤية","predictive maintenance"], a:
`باستخدام بيانات الاستشعار والتحليل، يمكن التنبؤ بوقت فشل مكونات البنية التحتية (مثل مضخات المياه أو مصاعد المباني) وتنفيذ صيانة قبل حدوث العطل، مما يقلل التكاليف ويطيل عمر المعدات.` },

  // الذكاء الاصطناعي — أساسيات
  { q: ["ما هو الذكاء الاصطناعي","تعريف الذكاء الاصطناعي"], a:
`الذكاء الاصطناعي هو مجال علمي يهدف لبناء أنظمة تحاكي قدرات البشر في التعلم، الاستدلال، واتخاذ القرار. يشمل مجموعة من التقنيات مثل تعلم الآلة (Machine Learning)، التعلم العميق (Deep Learning)، ومعالجة اللغة الطبيعية (NLP). تطبيقاته في المدن الذكية تشمل تحليل الفيديو، التنبؤ بالطلب، والتوصية بالسياسات.` },

  // تعلم الآلة وأنواعه
  { q: ["تعلم الآلة","machine learning"], a:
`تعلم الآلة هو فرع من الذكاء الاصطناعي يعتمد على نماذج تتعلم من البيانات. أنواعه: 
- التعلم المراقب (Supervised) للتنبؤ والتصنيف؛ 
- التعلم غير المراقب (Unsupervised) لاكتشاف الأنماط؛ 
- التعلم المعزز (Reinforcement) لتعلم استراتيجيات عبر مكافأة/عقاب. 
اختيار النوع يعتمد على المشكلة والبيانات المتاحة.` },

  // النماذج وتوزيعها
  { q: ["نشر النموذج","deployment","model serving"], a:
`بعد تدريب نموذج، يجب نشره بطريقة قابلة للوصول (API). الخيارات تشمل نشره على السحابة، على حافة الشبكة (Edge) للأداء المنخفض التأخير، أو استخدام حاويات (Docker/Kubernetes) لإدارة النسخ والتوسع. مراقبة أداء النموذج وإعادة تدريبه ببيانات جديدة أمر ضروري.` },

  // أخلاقيات وخصوصية
  { q: ["الخصوصية","اخلاقيات","privacy"], a:
`تطبيقات المدن الذكية تواجه تحديات خصوصية: جمع بيانات المواطنين قد ينتهك الخصوصية إذا لم تُطبق سياسات حماية قوية. أفضل الممارسات تشمل: تقليل بيانات التعريف، تشفير النقل والتخزين، حفظ البيانات لأقصر فترة ضرورية، واعتماد آليات الشفافية والموافقة للمواطنين.` },

  // أمن سيبراني
  { q: ["امن","سيبراني","cybersecurity"], a:
`الأمن السيبراني في المدن الذكية يشمل حماية الشبكات، أجهزة IoT، ومنصات البيانات من هجمات إلكترونية قد تعطل خدمات حيوية. يتطلب ذلك تحديثات أمنية منتظمة، تقسيم الشبكات، تشفير، واختبارات اختراق دورية.` },

  // حالات دراسية — أمثلة عالمية
  { q: ["سنغافورة","امستردام","دبي","كوبنهاغن","طوكيو"], a:
`أمثلة عملية: 
- سنغافورة: نظام لإدارة النقل والطاقة قائم على تحليل البيانات، وتخطيط حضري ذكي. 
- أمستردام: مشاريع مشاركة الدراجات والطاقة المتجددة. 
- دبي: حلول أمنية ومراقبة متقدمة ومبادرات مدن ذكية حكومية. 
- كوبنهاغن: تركيز قوي على جودة الهواء والبنية التحتية الخضراء. 
كل مدينة تتبنى نهجًا مختلفًا بحسب مواردها وأولوياتها.` },

  // كيفية البدء بمشروع مدينة ذكية — خطوات عملية
  { q: ["كيف أبدأ","خطوات","مشروع مدنية ذكية","ابدأ مشروع المدينة"], a:
`خطوات عملية لبدء مشروع مدينة ذكية:
1) تحديد الأهداف الواضحة (تقليل الازدحام، تحسين الطاقة...). 
2) إجراء مسح بيانات وبنية تحتية لتحديد نقاط الضعف. 
3) بدء مشاريع تجريبية صغيرة (pilots) في منطقة محددة. 
4) اختيار أجهزة استشعار وبروتوكولات اتصال مناسبة. 
5) بناء منصة بيانات قابلة للتوسع وتحليلات أولية. 
6) إشراك الجهات المعنية (البلدية، شركات الاتصالات، المواطنون). 
7) قياس الأداء، توسيع الناجح، وضمان الحوكمة والخصوصية.` },

  // التمويل و قياس العائد
  { q: ["تمويل","تكلفة","roi","عائد الاستثمار"], a:
`نموذج التمويل يمكن أن يجمع بين ميزانية حكومية، شراكات مع القطاع الخاص، ومنح دولية. لقياس العائد (ROI) يجب حساب التوفير في التشغيل (مثل الطاقة والصيانة)، الفوائد الاقتصادية (وقت السفر الموفر)، وتحسين الخدمات الصحية والتعليمية. إثبات الفائدة في مشاريع تجريبية يسهل جذب تمويل أوسع.` },

  // المعايير والتوافق
  { q: ["معايير","standards","interoperability"], a:
`التوافق بين أنظمة مختلفة يتطلب اعتماد معايير مفتوحة وبروتوكولات مشتركة لتبادل البيانات. اختيار معايير شائعة يقلل من التكلفة ويزيد من قابلية التكامل بين مزودين متعددين.` },

  // تقنيات متقدمة: التعلم الموزع، الحافة، الفيدرالية
  { q: ["edge computing","حافة","federated learning","تعلم موزع"], a:
`بعض التطبيقات الحساسة زمنياً تستفيد من الحوسبة على الحافة (Edge) بحيث تُعالَج البيانات محليًا لتقليل التأخير. للتعامل مع خصوصية البيانات، يمكن استخدام التعلم الفيدرالي حيث تتدرب النماذج محليًا على أجهزة متعددة وتُشارك فقط التحديثات النموذجية بدلاً من البيانات الخام.` },

  // البيانات المفتوحة والمشاركة
  { q: ["بيانات مفتوحة","open data","مشاركة البيانات"], a:
`إطلاق مجموعات بيانات مفتوحة يشجع الابتكار ويتيح للشركات والباحثين تطوير خدمات جديدة. لكن يجب ضمان إزالة معلومات التعريف وتطبيق سياسات استخدام واضحة لحماية المواطنين.` },

  // أدوات ومصادر للتعلم والتطبيق
  { q: ["مصادر","تعلم","datasets","tools"], a:
`مصادر مفيدة: منصات MOOCs (Coursera, edX) لدورات الذكاء الاصطناعي، مستودعات البيانات العامة (Kaggle)، وأطر عمل ML مثل TensorFlow وPyTorch. للمدن الذكية توجد وثائق من مؤسسات مثل ITU وISO تتعلق بالمعايير.` }
];

/* ---- helpers ---- */
function nowISO(){ return new Date().toISOString(); }
function timeLabel(ts){ return new Date(ts).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}); }
function normalize(s){
  if(!s) return '';
  return s.replace(/[أإآ]/g,'ا').replace(/ة/g,'ه').replace(/[^\w\u0600-\u06FF\s0-9]/g,'').toLowerCase().trim();
}

/* ---- storage ---- */
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){ try{ state = JSON.parse(raw); }catch(e){ state = {messages:[],attachments:[]} } }
  if(!state.messages || state.messages.length===0){
    state.messages = [{id:'bot-welcome',from:'bot',text:'مرحبًا! أنا سما. اسألني عن المدن الذكية، التكنولوجيا أو الذكاء الاصطناعي وسأعطيك إجابة تفصيلية ومقنعة.' ,ts:nowISO()}];
    save();
  }
}

/* ---- render ---- */
const msgsEl = document.getElementById('msgs');
function render(){
  msgsEl.innerHTML = '';
  for(const m of state.messages){
    const el = document.createElement('div');
    el.className = 'bubble ' + (m.from==='me' ? 'me' : 'bot');
    if(m.type==='image'){
      const img = document.createElement('img'); img.src = m.src; img.style.maxWidth='100%'; img.style.borderRadius='8px';
      el.appendChild(img);
    } else {
      el.textContent = m.text;
    }
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = timeLabel(m.ts);
    el.appendChild(meta);
    msgsEl.appendChild(el);
  }
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

/* ---- KB matching (improved) ---- */
function kbReply(text){
  const n = normalize(text);
  if(!n) return null;

  // direct contains match (longest-answer priority)
  // try to match multiple keywords for better precision
  let best = null;
  for(const item of KB){
    let score = 0;
    for(const q of item.q){
      const nq = normalize(q);
      if(n.includes(nq)) score += nq.length;
    }
    if(score>0 && (!best || score > best.score)) best = {item, score};
  }
  if(best) return best.item.a;

  // heuristic patterns
  if(/علمني|درس|ابدأ/.test(n)) return 'حسنًا — لو تريد درسًا مفصلاً، اختر موضوعًا: الطاقة، المواصلات، الأمن، الصحة، التعليم، إنترنت الأشياء، أو الذكاء الاصطناعي. اكتب اسم الموضوع لبدء درس مُفصل.';
  if(/ماذا|ما|لماذا|كيف|اين|متى/.test(n)) return 'السؤال عام؛ هل تقصد استفسارًا تقنيًا، مثالًا عمليًا، خطوات تنفيذية، أم دراسة حالة لمدينة معينة؟ اختر نوع الإجابة (تقني/عملي/دراسة حالة).';
  return null;
}

/* ---- bot logic ---- */
function botRespond(userText, hasImage=false){
  let reply = null;
  if(hasImage) {
    reply = 'شكرًا على الصورة. أستطيع اقتراح تحسينات لجعل التصميم مناسبًا للمدن الذكية (تحسين شبكات الطرق، إنارة ذكية، مواقع لأجهزة الاستشعار). هل تريد تفصيلًا لكل عنصر؟';
  } else {
    reply = kbReply(userText);
  }
  if(!reply){
    reply = 'سؤال هام! لإجابة مفصلة أحتاج أن تحدد إن كنت تريد: (1) تفسير مفاهيمي، (2) خطوات تطبيقية ومراحل المشروع، أو (3) أمثلة ودراسات حالة. اكتب رقم الخيار أو وصف موجز لطلبك.';
  }

  // typing simulation
  const typingEl = document.createElement('div');
  typingEl.className = 'bubble bot';
  typingEl.innerHTML = '...';
  msgsEl.appendChild(typingEl);
  msgsEl.scrollTop = msgsEl.scrollHeight;

  setTimeout(()=>{
    state.messages.push({id:'bot-'+Math.random().toString(36).slice(2), from:'bot', text:reply, ts:nowISO()});
    save(); render();
  }, 600 + Math.min(1600, Math.max(200, userText.length * 28)));
}

/* ---- UI actions ---- */
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('input').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

function sendMessage(){
  const input = document.getElementById('input');
  const text = input.value.trim();
  const attach = state.attachments.shift();
  if(!text && !attach) return;
  if(text){
    state.messages.push({id:'u-'+Math.random().toString(36).slice(2), from:'me', text, ts:nowISO()});
  }
  if(attach){
    state.messages.push({id:'u-'+Math.random().toString(36).slice(2), from:'me', type:'image', src:attach, ts:nowISO()});
  }
  input.value = '';
  save(); render();

  // respond
  botRespond(text || '', !!attach);
}

/* ---- attach handling ---- */
const attachBtn = document.getElementById('attachBtn');
const attachInput = document.getElementById('attachInput');
attachBtn.addEventListener('click', ()=> attachInput.click());
attachInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > 8*1024*1024){ alert('اختر صورة أقل من 8 ميجا'); return; }
  const r = new FileReader();
  r.onload = ()=> { state.attachments.push(r.result); save(); sendMessage(); }
  r.readAsDataURL(f);
});

/* ---- init ---- */
load();
render();
</script>
</body>
</html>
```
